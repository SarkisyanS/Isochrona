import streamlit as st


TEXTS = {
    "en": {
        "page_title": "Isochrone Builder",
        "lang_toggle": "Русский / Russian",
        "step1_title": "Step 1 – Upload point layer",
        "upload_label": "Upload point layer",
        "upload_help": "Supports GeoJSON/GPKG or CSV/Excel with latitude/longitude columns.",
        "csv_empty_error": "CSV appears to be empty.",
        "csv_cols_error": "CSV must have at least two columns for latitude and longitude.",
        "popover_title": "Select latitude / longitude columns",
        "popover_caption": "Pick which CSV columns contain coordinates.",
        "lat_col_label": "Latitude column",
        "lon_col_label": "Longitude column",
        "crs_input_label": "Coordinate CRS (EPSG code)",
        "crs_input_help": "Commonly EPSG:4326 for WGS84 latitude/longitude.",
        "lat_lon_same_warning": "Latitude and longitude columns must be different.",
        "csv_loaded_success": "Loaded {n} points (lat='{lat}', lon='{lon}', CRS={crs}).",
        "point_layer_loaded": "Point layer loaded: {n} features.",
        "error_read_point": "Error reading point file: {e}",
        "preview_points": "Points preview",
        "step2_title": "Step 2 – Provide roads",
        "road_source_label": "Road source",
        "road_source_osm": "Download from OSM",
        "road_source_upload": "Upload your own road file",
        "iso_radius_label": "Max isochrone radius (m)",
        "network_type_label": "OSM network type",
        "crs_metric_label": "Metric CRS (EPSG code for roads & points)",
        "download_roads_btn": "Download roads around points",
        "roads_loaded_success": "OSM roads loaded around points.",
        "error_downloading_roads": "Error downloading OSM roads: {e}",
        "roads_file_loaded": "Road layer loaded: {n} segments.",
        "error_read_roads": "Error reading road file: {e}",
        "build_graph_btn": "Build graph using current roads",
        "error_build_graph": "Error building graph: {e}",
        "graph_built_success": "Graph built ({nodes} nodes, {edges} edges).",
        "graph_cached_caption": "Cached graph: {nodes} nodes, {edges} edges (CRS: {crs})",
        "preview_roads": "Roads preview",
        "step3_title": "Additional parameters",
        "distances_label": "Isochrone distances (m, comma-separated)",
        "distances_help": "Example: 500, 700, 1500",
        "max_snap_label": "Max snap distance to nearest road (m)",
        "current_crs": "Current metric CRS: `{crs}`",
        "boundary_type_label": "Isochrone boundary type",
        "boundary_help": "'buffer' – network-buffer-based isochrone. 'concave' – concave hull.",
        "concave_warning": "Concave hull selected, but `alphashape` is not installed (pip install alphashape).",
        "concave_alpha_label": "Concave hull alpha (0 = auto)",
        "edge_width_label": "Edge width for buffering (m)",
        "smoothing_label": "Smoothing radius (m)",
        "parse_distance_error": "Could not parse distances. Please enter integers separated by commas.",
        "step4_title": "Step 4 – Run isochrones",
        "compute_btn": "Compute isochrones",
        "error_upload_points": "Please upload a point layer in Step 1.",
        "error_provide_roads": "Please provide roads in Step 2.",
        "error_build_graph_first": "Please build the graph in Step 2 before computing isochrones.",
        "error_valid_distance": "Please provide at least one valid distance.",
        "error_concave_missing": "Concave hull selected, but `alphashape` is not installed.",
        "crs_mismatch_error": "Cached graph CRS {cached} != current CRS {current}. Rebuild graph.",
        "no_iso_warning": "No valid isochrones generated.",
        "iso_success": "Generated {n} isochrone polygons.",
        "iso_compute_error": "Error during isochrone computation: {e}",
        "download_results_title": "**Download results**",
        "download_button_label": "Download isochrones as GeoJSON (WGS84, all distance bands)",
        "iso_preview": "Isochrones (attributes)",
        "clear_iso_btn": "Clear isochrones",
        "clear_all_btn": "Clear all",
        "map_style_label": "Basemap color",
        "map_style_light": "Light",
        "map_style_dark": "Dark",
        "map_style_osm": "OSM",
        "map_export_btn": "Download map as HTML",
    },
    "ru": {
        "page_title": "Построение изохрон",
        "lang_toggle": "Русский / Russian",
        "step1_title": "Шаг 1 — Загрузите слой точек",
        "upload_label": "Загрузите слой точек",
        "upload_help": "Поддерживаются GeoJSON/GPKG или CSV/Excel с колонками широты/долготы.",
        "csv_empty_error": "CSV-файл пуст.",
        "csv_cols_error": "CSV должен содержать минимум две колонки: широту и долготу.",
        "popover_title": "Выберите столбцы с широтой/долготой",
        "popover_caption": "Укажите, какие столбцы содержат координаты.",
        "lat_col_label": "Столбец широты",
        "lon_col_label": "Столбец долготы",
        "crs_input_label": "Система координат точек (EPSG)",
        "crs_input_help": "Чаще всего EPSG:4326 для широты/долготы WGS84.",
        "lat_lon_same_warning": "Столбцы широты и долготы должны отличаться.",
        "csv_loaded_success": "Загружено {n} точек (широта='{lat}', долгота='{lon}', CRS={crs}).",
        "point_layer_loaded": "Слой точек загружен: {n} объектов.",
        "error_read_point": "Ошибка чтения файла точек: {e}",
        "preview_points": "Просмотр точек",
        "step2_title": "Шаг 2 — Добавьте дороги",
        "road_source_label": "Источник дорог",
        "road_source_osm": "Скачать из OSM",
        "road_source_upload": "Загрузить собственный файл дорог",
        "iso_radius_label": "Максимальный радиус изохроны (м)",
        "network_type_label": "Тип сети OSM",
        "crs_metric_label": "Метрика CRS (EPSG для дорог и точек)",
        "download_roads_btn": "Скачать дороги вокруг точек",
        "roads_loaded_success": "Дороги из OSM загружены вокруг точек.",
        "error_downloading_roads": "Ошибка загрузки дорог из OSM: {e}",
        "roads_file_loaded": "Слой дорог загружен: {n} сегментов.",
        "error_read_roads": "Ошибка чтения файла дорог: {e}",
        "build_graph_btn": "Построить граф по текущим дорогам",
        "error_build_graph": "Ошибка построения графа: {e}",
        "graph_built_success": "Граф построен ({nodes} вершин, {edges} ребер).",
        "graph_cached_caption": "Кэшированный граф: {nodes} вершин, {edges} ребер (CRS: {crs})",
        "preview_roads": "Просмотр дорог",
        "step3_title": "Дополнительные параметры",
        "distances_label": "Дистанции изохрон (м, через запятую)",
        "distances_help": "Например: 500, 700, 1500",
        "max_snap_label": "Макс. расстояние привязки к дороге (м)",
        "current_crs": "Текущая метрическая CRS: `{crs}`",
        "boundary_type_label": "Тип границы изохроны",
        "boundary_help": "'buffer' — изохрона на основе буфера сети. 'concave' — вогнутая оболочка.",
        "concave_warning": "Выбрана вогнутая оболочка, но `alphashape` не установлен (pip install alphashape).",
        "concave_alpha_label": "Параметр alpha для вогнутой оболочки (0 = авто)",
        "edge_width_label": "Толщина ребер для буфера (м)",
        "smoothing_label": "Радиус сглаживания (м)",
        "parse_distance_error": "Не удалось разобрать дистанции. Введите целые числа через запятую.",
        "step4_title": "Шаг 4 — Построить изохроны",
        "compute_btn": "Построить изохроны",
        "error_upload_points": "Загрузите слой точек на Шаге 1.",
        "error_provide_roads": "Добавьте дороги на Шаге 2.",
        "error_build_graph_first": "Постройте граф на Шаге 2 перед расчетом изохрон.",
        "error_valid_distance": "Укажите хотя бы одну корректную дистанцию.",
        "error_concave_missing": "Выбрана вогнутая оболочка, но `alphashape` не установлен.",
        "crs_mismatch_error": "CRS кэшированного графа {cached} не совпадает с текущей {current}. Постройте граф заново.",
        "no_iso_warning": "Не удалось построить изохроны.",
        "iso_success": "Построено {n} полигонов изохрон.",
        "iso_compute_error": "Ошибка при расчете изохрон: {e}",
        "download_results_title": "**Скачать результаты**",
        "download_button_label": "Скачать изохроны как GeoJSON (WGS84, все дистанции)",
        "iso_preview": "Изохроны (атрибуты)",
        "clear_iso_btn": "Очистить изохроны",
        "clear_all_btn": "Сбросить всё",
        "map_style_label": "Цвет подложки",
        "map_style_light": "Светлая",
        "map_style_dark": "Тёмная",
        "map_style_osm": "OSM",
        "map_export_btn": "Скачать карту как HTML",
    },
}


def t(key, **kwargs):
    """
    Translate UI string for current language stored in session_state.
    Falls back to English and returns the key if not found.
    """
    lang = st.session_state.get("lang", "en")
    template = TEXTS.get(lang, TEXTS["en"]).get(key, TEXTS["en"].get(key, key))
    try:
        return template.format(**kwargs)
    except Exception:
        return template
